#!/bin/bash

set -e

echo "----------------------------------------------------------------------------------------------------"
echo "Copying spirv-tools"
echo "----------------------------------------------------------------------------------------------------"
rm -rf tmp
mkdir tmp
cp -r spirv-tools tmp
pushd tmp/spirv-tools

echo "----------------------------------------------------------------------------------------------------"
echo "Syncing git submodules"
echo "----------------------------------------------------------------------------------------------------"
python3 utils/git-sync-deps

echo "----------------------------------------------------------------------------------------------------"
echo "Generating build files"
echo "----------------------------------------------------------------------------------------------------"
mkdir -p build && pushd build
cmake -GNinja -DSPIRV_SKIP_TESTS=ON ..
ninja
popd

echo "----------------------------------------------------------------------------------------------------"
echo "Copying generated headers"
echo "----------------------------------------------------------------------------------------------------"
rm -rf ../../spirv-tools-generated
mkdir -p ../../spirv-tools-generated
find build -name "*.inc" -exec cp -r '{}' ../../spirv-tools-generated/ \;

echo "----------------------------------------------------------------------------------------------------"
echo "Cleaning up"
echo "----------------------------------------------------------------------------------------------------"
popd
rm -rf tmp
