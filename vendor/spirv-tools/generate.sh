#!/bin/bash

set -e

echo "----------------------------------------------------------------------------------------------------"
echo "Copying spirv-tools"
echo "----------------------------------------------------------------------------------------------------"
rm -rf tmp
mkdir tmp
cp -r upstream tmp
pushd tmp/upstream

echo "----------------------------------------------------------------------------------------------------"
echo "Syncing git submodules"
echo "----------------------------------------------------------------------------------------------------"
python3 utils/git-sync-deps

echo "----------------------------------------------------------------------------------------------------"
echo "Generating build files"
echo "----------------------------------------------------------------------------------------------------"
mkdir -p build && pushd build
cmake -GNinja -DSPIRV_SKIP_TESTS=ON ..
ninja
popd

echo "----------------------------------------------------------------------------------------------------"
echo "Copying generated headers"
echo "----------------------------------------------------------------------------------------------------"
rm -rf ../../generated
mkdir -p ../../generated
find build -name "*.inc" -exec cp -r '{}' ../../generated/ \;

echo "----------------------------------------------------------------------------------------------------"
echo "Cleaning up"
echo "----------------------------------------------------------------------------------------------------"
popd
rm -rf tmp
